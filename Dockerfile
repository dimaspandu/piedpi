# ----------------------------------------------------------------------
# Piedpi – Minimal Production‑Ready PHP Docker Image
# ----------------------------------------------------------------------
# This image is intentionally simple and explicit.
# No framework, no process manager, no magic.
# ----------------------------------------------------------------------

FROM php:8.3-cli-alpine

# ----------------------------------------------------------------------
# Install system dependencies
# ----------------------------------------------------------------------
RUN apk add --no-cache \
    bash \
    curl \
    git \
    icu-dev \
    oniguruma-dev \
    libzip-dev \
    mariadb-client

# ----------------------------------------------------------------------
# Enable required PHP extensions
# ----------------------------------------------------------------------
RUN docker-php-ext-install \
    pdo \
    pdo_mysql \
    intl \
    mbstring \
    zip

# ----------------------------------------------------------------------
# Set working directory
# ----------------------------------------------------------------------
WORKDIR /app

# ----------------------------------------------------------------------
# Copy application files
# ----------------------------------------------------------------------
COPY . /app

# ----------------------------------------------------------------------
# Ensure storage directory is writable
# ----------------------------------------------------------------------
RUN mkdir -p storage \
    && chmod -R 775 storage

# ----------------------------------------------------------------------
# Expose application port
# ----------------------------------------------------------------------
EXPOSE 8080

# ----------------------------------------------------------------------
# Default environment values
# ----------------------------------------------------------------------
ENV APP_ENV=production \
    APP_DEBUG=false \
    APP_BASE_PATH= \
    APP_BASE_URL=http://localhost:8080

# ----------------------------------------------------------------------
# Start built‑in PHP server
# ----------------------------------------------------------------------
# Front controller is index.php at project root
# ----------------------------------------------------------------------
CMD ["php", "-S", "0.0.0.0:8080", "index.php"]
